<!DOCTYPE html>
<html lang="en">
  
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="au theme template">
    <meta name="author" content="Hau Nguyen">
    <meta name="keywords" content="au theme template">
    <title>Menu Dashboard FBB</title>

    <!-- CSS Files -->
    <link href="css/font-face.css" rel="stylesheet">
    <link href="vendor/font-awesome-4.7/css/font-awesome.min.css" rel="stylesheet">
    <link href="vendor/font-awesome-5/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="vendor/mdi-font/css/material-design-iconic-font.min.css" rel="stylesheet">
    <link href="vendor/bootstrap-4.1/bootstrap.min.css" rel="stylesheet">
    <link href="vendor/animsition/animsition.min.css" rel="stylesheet">
    <link href="vendor/bootstrap-progressbar/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
    <link href="vendor/wow/animate.css" rel="stylesheet">
    <link href="vendor/css-hamburgers/hamburgers.min.css" rel="stylesheet">
    <link href="vendor/slick/slick.css" rel="stylesheet">
    <link href="vendor/select2/select2.min.css" rel="stylesheet">
    <link href="vendor/perfect-scrollbar/perfect-scrollbar.css" rel="stylesheet">
    <link href="css/theme.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      .main-content {
        max-width: 1600px;
        margin: 0 auto;
        background: #f7fafc;
        border-radius: 18px;
        padding: 32px 24px 32px 24px;
        min-height: 100vh;
      }
      .dashboard-row {
        display: flex;
        gap: 32px;
        margin-bottom: 32px;
      }
      .dashboard-row > div {
        flex: 1 1 0;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 12px 0 #0001;
        padding: 24px 16px 24px 16px;
        min-width: 0;
        min-height: 420px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        background: #fff;
        margin-top: 8px;
      }
      th, td {
        border: 1px solid #e5e7eb;
        padding: 8px 12px;
        text-align: left;
      }
      th {
        background: #f3f4f6;
        font-weight: bold;
      }
      tr:nth-child(even) td {
        background: #f9fafb;
      }
    </style>
</head>

<body class="animsition">
    <div class="page-wrapper">
        <!-- Header Mobile -->
        <header class="header-mobile d-block d-lg-none">
            <div class="header-mobile__bar">
                <div class="container-fluid">
                    <div class="header-mobile-inner">
                        <a class="logo" href="index.html">
                            <img src="images/icon/logo.png" alt="CoolAdmin">
                        </a>
                        <button class="hamburger hamburger--slider" type="button">
                            <span class="hamburger-box">
                                <span class="hamburger-inner"></span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            <nav class="navbar-mobile">
                <div class="container-fluid">
                    <ul class="navbar-mobile__list list-unstyled">
                        <li><a href="#"><i class="fas fa-tachometer-alt"></i>Dashboard</a></li>
                        <li><a href="chart.html"><i class="fas fa-chart-bar"></i>Charts</a></li>
                        <li><a href="table.html"><i class="fas fa-table"></i>Tables</a></li>
                        <li><a href="calendar.html"><i class="fas fa-calendar-alt"></i>Calendar</a></li>
                        <li><a href="map.html"><i class="fas fa-map-marker-alt"></i>Maps</a></li>
                        <li><a href="login.html"><i class="fas fa-sign-in-alt"></i>Login</a></li>
                        <li><a href="register.html"><i class="fas fa-user-plus"></i>Register</a></li>
                        <li><a href="forget-pass.html"><i class="fas fa-key"></i>Forget Password</a></li>
                    </ul>
                </div>
            </nav>
        </header>
        
        <!-- Sidebar -->
        <aside class="menu-sidebar d-none d-lg-block">
            <div class="logo">
                <a href="#">
                    <img src="images/icon/logo.png" alt="FBB">
                </a>
            </div>
            <div class="menu-sidebar__content js-scrollbar1">
                <nav class="navbar-sidebar">
                    <ul class="list-unstyled navbar__list">
                        <li class="active has-sub">
                            <a class="js-arrow" href="#"><i class="fas fa-tachometer-alt"></i>Dashboard</a>
                        </li>
                        <li><a href="hk.html"><i class="fas fa-house-user"></i>House Keeping</a></li>
                        <li class="has-sub">
                            <a class="js-arrow" href="#"><i class="fas fa-chart-line"></i>Achievement</a>
                            <ul class="list-unstyled navbar__sub-list js-sub-list">
                                <li><a href="monthly.html">Data Monthly</a></li>
                                <li><a href="daily.html">Data Daily</a></li>
                                <li><a href="fallout.html">Data Fallout</a></li>
                            </ul>
                        </li>
                        <li><a href="map.html"><i class="fas fa-map-marker-alt"></i>Maps</a></li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- Page Container -->
        <div class="page-container">
            <!-- Headbar Menu (moved here) -->
            <div class="w-full bg-white shadow flex items-center justify-between px-8 py-3 z-10" style="position:sticky;top:0;">
                <div class="flex items-center gap-4">
                    <span class="text-xl font-bold text-gray-800">Performance Dashboard</span>
                </div>
                <div class="flex items-center gap-6 text-gray-600">
                    <a href="#" class="hover:text-blue-600 transition">Home</a>
                    <a href="#" class="hover:text-blue-600 transition">Reports</a>
                    <a href="#" class="hover:text-blue-600 transition">Settings</a>
                    <span class="text-xs text-gray-400 ml-4"><i class="fa fa-thumbtack text-pink-500"></i> Last Updated: Senin 4/24/2025</span>
                </div>
            </div>
            <main class="main-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard Overview</h2>
                <div class="flex flex-wrap gap-4 mb-6 items-end">
                    <select id="branchFilter" class="border rounded px-2 py-1"></select>
                    <input type="date" id="startDate" class="border rounded px-2 py-1">
                    <input type="date" id="endDate" class="border rounded px-2 py-1">
                    <button onclick="applyFilters()" class="bg-blue-500 text-white px-4 py-1 rounded">Filter</button>
                </div>
                <div class="dashboard-row">
                    <div>
                        <h3 class="font-bold mb-2">Fallout & HK</h3>
                        <canvas id="pieHK" width="260" height="260"></canvas>
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">Symptom</h3>
                        <canvas id="progressSymptom" width="420" height="260"></canvas>
                    </div>
                </div>
                <div class="dashboard-row">
                    <div style="flex: 1 1 100%; max-width: 100%;">
                        <h3 class="font-bold mb-2">Trend Fallout to PS</h3>
                        <canvas id="barTrend" width="900" height="320"></canvas>
                    </div>
                </div>
                <div class="dashboard-row">
                    <div style="overflow-x:auto;">
                        <h3 class="font-bold mb-2">Symptom to PS</h3>
                        <table id="tableSymptom" class="min-w-full text-xs"></table>
                    </div>
                    <div style="overflow-x:auto;">
                        <h3 class="font-bold mb-2">Fallout NOP to PS</h3>
                        <table id="tableNop" class="min-w-full text-xs"></table>
                    </div>
                    <div style="overflow-x:auto;">
                        <h3 class="font-bold mb-2">Result House Keeping</h3>
                        <table id="tableHK" class="min-w-full text-xs"></table>
                    </div>
                </div>
            </main>
            <!-- Improved Footer -->
            <footer class="w-full bg-gray-100 py-6 mt-8 shadow-inner">
                <div class="container mx-auto flex flex-col md:flex-row justify-between items-center px-6">
                    <div class="flex items-center gap-2 mb-2 md:mb-0">
                        <img src="images/icon/logo.png" alt="FBB" class="h-8 w-auto">
                        <span class="text-gray-700 font-semibold">FBB Telkomsel</span>
                    </div>
                    <div class="text-gray-500 text-sm">&copy; 2025 FBB Telkomsel. All rights reserved.</div>
                    <div class="flex gap-3 mt-2 md:mt-0">
                        <a href="#" class="text-gray-400 hover:text-blue-600"><i class="fab fa-facebook"></i></a>
                        <a href="#" class="text-gray-400 hover:text-blue-600"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-gray-400 hover:text-blue-600"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
            </footer>
        </div>
        <!-- JS Files -->
        <script src="vendor/jquery-3.2.1.min.js"></script>
        <script src="vendor/bootstrap-4.1/popper.min.js"></script>
        <script src="vendor/bootstrap-4.1/bootstrap.min.js"></script>
        <script src="vendor/slick/slick.min.js"></script>
        <script src="vendor/wow/wow.min.js"></script>
        <script src="vendor/animsition/animsition.min.js"></script>
        <script src="vendor/bootstrap-progressbar/bootstrap-progressbar.min.js"></script>
        <script src="vendor/counter-up/jquery.waypoints.min.js"></script>
        <script src="vendor/counter-up/jquery.counterup.min.js"></script> 
        <script src="vendor/circle-progress/circle-progress.min.js"></script> 
        <script src="vendor/perfect-scrollbar/perfect-scrollbar.js"></script> 
        <script src="vendor/chartjs/Chart.bundle.min.js"></script> 
        <script src="vendor/select2/select2.min.js"></script> 
        <script src="js/main.js"></script>
        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- Firebase SDK -->
        <script type="module">
          import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
          import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

          const firebaseConfig = {
            apiKey: "AIzaSyCjBlPnJSlEq18tJett5ZdOAcMl2yPvlOE",
            authDomain: "fbb-fullfilment.firebaseapp.com",
            projectId: "fbb-fullfilment",
            storageBucket: "fbb-fullfilment.firebasestorage.app",
            messagingSenderId: "842233083514",
            appId: "1:842233083514:web:beb0ce0ac38fc5825eedc3",
            measurementId: "G-9RPL0LSY4Q"
          };

          const app = initializeApp(firebaseConfig);
          const db = getFirestore(app);

          let allData = [];

          async function fetchData() {
            const snapshot = await getDocs(collection(db, "fallout"));
            return snapshot.docs.map(doc => doc.data());
          }

          function filterData(data, branch, startDate, endDate) {
            return data.filter(d => {
              if (branch && (d.branch || '').trim() !== branch.trim()) return false;
              if (startDate || endDate) {
                let proviDate = new Date(d.provi_ts);
                if (startDate && proviDate < startDate) return false;
                if (endDate) {
                  let endDateEnd = new Date(endDate);
                  endDateEnd.setHours(23,59,59,999);
                  if (proviDate > endDateEnd) return false;
                }
              }
              return true;
            });
          }

          function renderPieHK(dataToRender) {
            const total = dataToRender.length;
            const filled = dataToRender.filter(d => d.status_hk && d.status_hk.trim() !== "").length;
            const unfilled = total - filled;
            const ctx = document.getElementById('pieHK').getContext('2d');
            if (window.pieHKChart) window.pieHKChart.destroy();
            window.pieHKChart = new Chart(ctx, {
              type: 'pie',
              data: {
                labels: ['Sudah HK', 'Belum HK'],
                datasets: [{
                  data: [filled, unfilled],
                  backgroundColor: ['#4ade80', '#f87171']
                }]
              },
              options: {
                plugins: {
                  datalabels: {
                    color: '#222',
                    font: { weight: 'bold', size: 16 },
                    formatter: function(value, context) {
                      const percent = total > 0 ? (value / total * 100).toFixed(1) : 0;
                      return value + ' (' + percent + '%)';
                    }
                  },
                  legend: {
                    display: true,
                    position: 'top'
                  },
                  title: {
                    display: true,
                    text: 'Fallout & HK'
                  }
                }
              },
              plugins: [ChartDataLabels]
            });
          }

          function parseMonth(str) {
            if (!str) return null;
            if (typeof str === 'object' && str.seconds) {
              const date = new Date(str.seconds * 1000);
              return { month: date.getMonth() + 1, year: date.getFullYear() };
            }
            if (typeof str !== 'string') str = String(str);
            const match = str.match(/([A-Za-z]+)\s+\d{1,2},\s+(\d{4})/);
            if (!match) return null;
            const monthStr = match[1];
            const yearStr = match[2];
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const month = months.findIndex(m => m.toLowerCase() === monthStr.toLowerCase());
            return { month: month+1, year: parseInt(yearStr) };
          }

          function renderBarTrend(dataToRender) {
            const months = Array.from({length: 12}, (_, i) => i+1);
            const falloutPerMonth = months.map(m => dataToRender.filter(d => {
              const parsed = parseMonth(d.provi_ts);
              return d.order_id && d.order_id !== '' && parsed && parsed.month === m;
            }).length);
            const psPerMonth = months.map(m => dataToRender.filter(d => {
              const parsed = parseMonth(d.provi_ts);
              return d.order_id && d.order_id !== '' && d.status_ps === "PS" && parsed && parsed.month === m;
            }).length);
            
            const percentPerMonth = falloutPerMonth.map((f, i) => f > 0 ? (psPerMonth[i] / f * 100).toFixed(2) : 0);

            const maxBar = Math.max(...falloutPerMonth, ...psPerMonth);
            const maxPercent = Math.max(...percentPerMonth.map(x => Number(x) || 0));

            const ctx = document.getElementById('barTrend').getContext('2d');
            if(window.barTrendChart) window.barTrendChart.destroy();
            window.barTrendChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'],
                datasets: [
                  { 
                    label: 'Fallout', 
                    data: falloutPerMonth, 
                    backgroundColor: '#60a5fa', 
                    yAxisID: 'y',
                    barPercentage: 0.5,
                    categoryPercentage: 0.5
                  },
                  { 
                    label: 'PS', 
                    data: psPerMonth, 
                    backgroundColor: '#fbbf24', 
                    yAxisID: 'y',
                    barPercentage: 0.5,
                    categoryPercentage: 0.5
                  },
                  { 
                    label: 'Fallout to PS (%)', 
                    data: percentPerMonth, 
                    type: 'line', 
                    borderColor: '#ef4444', 
                    backgroundColor: '#ef4444', 
                    fill: false, 
                    yAxisID: 'y1', 
                    tension: 0.3,
                    order: 99,
                    pointRadius: 4,
                    borderWidth: 3
                  }
                ]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: 'top' },
                  title: { display: true, text: 'Trend Fallout to PS' }
                },
                scales: {
                  y: { beginAtZero: true, max: (maxBar > 0 ? maxBar * 2 : 5), title: { display: true, text: 'Jumlah' } },
                  y1: {
                    beginAtZero: true,
                    max: (maxPercent > 0 ? maxPercent * 2 : 100),
                    position: 'right',
                    title: { display: true, text: 'Fallout to PS (%)' },
                    grid: { drawOnChartArea: false },
                    ticks: { callback: v => v + '%' }
                  }
                }
              }
            });
          }

          function renderProgressSymptom(dataToRender) {
            const status = {};
            dataToRender.forEach(d => {
              if (d.status_ps === 'PS') return;
              let key = d.status_hk;
              if (!key || key.trim() === "") key = "Stay Fallout";
              status[key] = (status[key] || 0) + 1;
            });
            const total = Object.values(status).reduce((a, b) => a + b, 0);
            let arr = Object.entries(status).map(([label, value]) => ({
              label,
              value,
              percent: total > 0 ? (value / total * 100) : 0
            }));
            arr.sort((a, b) => b.percent - a.percent);
            const maxValue = Math.max(...arr.map(x => x.value)) + 2;
            new Chart(document.getElementById('progressSymptom'), {
              type: 'bar',
              data: {
                labels: arr.map(x => x.label),
                datasets: [{
                  label: 'Jumlah',
                  data: arr.map(x => x.value),
                  backgroundColor: '#34d399',
                  borderRadius: 12,
                  barPercentage: 0.7,
                  categoryPercentage: 0.7
                }]
              },
              options: {
                indexAxis: 'y',
                plugins: {
                  legend: { display: false },
                  title: { display: true, text: 'Progress House Keeping (Symptom)' },
                  datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: '#222',
                    font: { weight: 'bold', size: 14 },
                    clip: false,
                    formatter: function(value, context) {
                      const percent = arr[context.dataIndex].percent;
                      return value + ' (' + percent.toFixed(1) + '%)';
                    }
                  }
                },
                layout: { padding: { right: 40 } },
                scales: {
                  x: { beginAtZero: true, title: { display: true, text: 'Jumlah' }, max: maxValue },
                  y: { title: { display: true, text: 'Status HK' } }
                }
              },
              plugins: [ChartDataLabels]
            });
          }

          function renderTableSymptom(data) {
            const group = {};
            data.forEach(d => {
              if (!group[d.symptom]) group[d.symptom] = { total: 0, ps: 0 };
              group[d.symptom].total++;
              if (d.status_ps === "PS") group[d.symptom].ps++;
            });
            let html = `<tr><th>Symptom</th><th>Total</th><th>PS</th></tr>`;
            let total = 0, ps = 0;
            for (const [symptom, val] of Object.entries(group)) {
              html += `<tr><td>${symptom}</td><td>${val.total}</td><td>${val.ps}</td></tr>`;
              total += val.total; ps += val.ps;
            }
            html += `<tr><th>Grand Total</th><th>${total}</th><th>${ps}</th></tr>`;
            document.getElementById('tableSymptom').innerHTML = html;
          }

          function renderTableNop(data) {
            const group = {};
            data.forEach(d => {
              if (!group[d.branch]) group[d.branch] = { total: 0, ps: 0 };
              group[d.branch].total++;
              if (d.status_ps === "PS") group[d.branch].ps++;
            });
            let html = `<tr><th>NOP</th><th>Total Fallout</th><th>PS</th></tr>`;
            let total = 0, ps = 0;
            for (const [branch, val] of Object.entries(group)) {
              html += `<tr><td>${branch}</td><td>${val.total}</td><td>${val.ps}</td></tr>`;
              total += val.total; ps += val.ps;
            }
            html += `<tr><th>Grand Total</th><th>${total}</th><th>${ps}</th></tr>`;
            document.getElementById('tableNop').innerHTML = html;
          }

          function renderTableHK(data) {
            const group = {};
            data.forEach(d => {
              let key = d.status_hk;
              if (!key || key.trim() === "") key = "Stay Fallout";
              if (!group[key]) group[key] = { total: 0, ps: 0, cancel: 0, stay: 0 };
              group[key].total++;
              if (d.status_ps === "PS") group[key].ps++;
              else if (d.status_ps === "Cancel") group[key].cancel++;
              else group[key].stay++;
            });
            let html = `<tr><th>House Keeping</th><th>Total</th><th>PS</th><th>Cancel</th><th>Stay</th></tr>`;
            let total = 0, ps = 0, cancel = 0, stay = 0;
            for (const [hk, val] of Object.entries(group)) {
              html += `<tr><td>${hk}</td><td>${val.total}</td><td>${val.ps}</td><td>${val.cancel}</td><td>${val.stay}</td></tr>`;
              total += val.total;
              ps += val.ps;
              cancel += val.cancel;
              stay += val.stay;
            }
            html += `<tr><th>Grand Total</th><th>${total}</th><th>${ps}</th><th>${cancel}</th><th>${stay}</th></tr>`;
            document.getElementById('tableHK').innerHTML = html;
          }

          function renderBranchFilter(data) {
            const unique = {};
            data.forEach(d => {
              const norm = (d.branch || '').trim().toUpperCase();
              if (norm && !unique[norm]) unique[norm] = (d.branch || '').trim();
            });
            const branches = Object.values(unique);
            document.getElementById('branchFilter').innerHTML =
              `<option value="">All Branch</option>` +
              branches.map(b => `<option value="${b}">${b}</option>`).join('');
          }

          function renderDashboard(data) {
            renderBranchFilter(allData);
            renderPieHK(data);
            renderBarTrend(data);
            renderProgressSymptom(data);
            renderTableSymptom(data);
            renderTableNop(data);
            renderTableHK(data);
          }

          window.applyFilters = function() {
            const branch = document.getElementById('branchFilter').value;
            const startDateRaw = document.getElementById('startDate').value;
            const endDateRaw = document.getElementById('endDate').value;
            const startDate = startDateRaw ? new Date(startDateRaw) : null;
            const endDate = endDateRaw ? new Date(endDateRaw) : null;
            const filtered = filterData(allData, branch, startDate, endDate);
            renderDashboard(filtered);
          }

          document.addEventListener('DOMContentLoaded', async function() {
            allData = await fetchData();
            renderDashboard(allData);
          });
        </script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    </body> 
</html>