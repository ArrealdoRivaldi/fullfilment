<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-copy { background: #3b82f6; color: white; }
        .btn-csv { background: #10b981; color: white; }
        .btn-excel { background: #059669; color: white; }
        .btn:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <h1>Export Functionality Test</h1>
    
    <div class="test-section">
        <h2>Test Data</h2>
        <p>This test will verify that the export functions work correctly with sample data.</p>
        
        <div>
            <button class="btn btn-copy" onclick="testCopy()">
                <i class="fa fa-copy"></i> Test Copy
            </button>
            <button class="btn btn-csv" onclick="testCSV()">
                <i class="fa fa-file-csv"></i> Test CSV
            </button>
            <button class="btn btn-excel" onclick="testExcel()">
                <i class="fa fa-file-excel"></i> Test Excel
            </button>
        </div>
        
        <div id="result" style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 4px;"></div>
    </div>

    <script>
        // Sample data for testing
        const testData = [
            {
                order_id: "ORD001",
                provi_ts: new Date("2024-01-15"),
                branch: "Jakarta",
                wok: "WOK001",
                sto_co: "STO001",
                fallout_reason: "Network issue",
                symptom: "Connection lost",
                status_hk: "Done",
                remark: [{text: "Issue resolved"}],
                status_ps: "Completed",
                new_order_id: "NEW001"
            },
            {
                order_id: "ORD002",
                provi_ts: new Date("2024-01-16"),
                branch: "Bandung",
                wok: "WOK002",
                sto_co: "STO002",
                fallout_reason: "Hardware failure",
                symptom: "Device offline",
                status_hk: "PT2",
                remark: [{text: "Replacement needed"}],
                status_ps: "In Progress",
                new_order_id: "NEW002"
            }
        ];

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                let date;
                if (typeof dateStr === 'object' && dateStr?.seconds) {
                    date = new Date(dateStr.seconds * 1000);
                } else if (typeof dateStr === 'string' && dateStr.trim()) {
                    date = new Date(dateStr);
                } else {
                    date = new Date(dateStr);
                }
                return !isNaN(date.getTime()) 
                    ? `${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getFullYear()}`
                    : 'Invalid Date';
            } catch (e) {
                return 'Format Error';
            }
        }

        function hitungAgingHari(provi_ts) {
            let proviDate;
            if (typeof provi_ts === 'object' && provi_ts?.seconds) {
                proviDate = new Date(provi_ts.seconds * 1000);
            } else if (typeof provi_ts === 'string' && provi_ts.trim()) {
                proviDate = new Date(provi_ts);
            } else {
                proviDate = new Date(provi_ts);
            }
            
            if (isNaN(proviDate.getTime())) return null;
            
            const now = new Date();
            proviDate.setHours(0, 0, 0, 0);
            now.setHours(0, 0, 0, 0);
            
            return Math.floor((now - proviDate) / (1000 * 60 * 60 * 24));
        }

        function mapAging(hari) {
            if (hari <= 3) return '1-3 hari';
            if (hari <= 7) return '4-7 hari';
            if (hari <= 14) return '8-14 hari';
            if (hari <= 30) return '14-30 hari';
            return '> 30 Hari';
        }

        function exportFilteredData(type) {
            const headers = [
                'No', 'Order ID', 'Provi ts', 'Branch', 'WOK', 'STO', 'Fallout Reason', 
                'Symptom', 'Status HK', 'Remark', 'Status PS', 'Aging Fallout', 'New Order id'
            ];
            
            const rows = testData.map((item, idx) => [
                idx + 1,
                item.order_id || '',
                formatDate(item.provi_ts),
                item.branch || '',
                item.wok || '',
                item.sto_co || '',
                item.fallout_reason || '',
                item.symptom || '',
                item.status_hk || '',
                (item.remark && item.remark.length > 0) ? item.remark.map(r => r.text).join(' | ') : '',
                item.status_ps || '',
                mapAging(hitungAgingHari(item.provi_ts)),
                item.new_order_id || ''
            ]);

            if (type === 'copy') {
                const text = [headers, ...rows].map(r => r.join('\t')).join('\n');
                navigator.clipboard.writeText(text).then(() => {
                    showResult('Data copied to clipboard successfully!', 'success');
                }).catch(err => {
                    showResult('Failed to copy: ' + err.message, 'error');
                });
            } else if (type === 'csv') {
                const csv = [headers, ...rows].map(r => 
                    r.map(v => '"' + (v||'').toString().replace(/"/g,'""') + '"').join(',')
                ).join('\n');
                const blob = new Blob([csv], {type: 'text/csv'});
                saveAs(blob, 'export-housekeeping.csv');
                showResult('CSV file downloaded successfully!', 'success');
            } else if (type === 'excel') {
                const xls = '<table><tr>' + headers.map(h => '<th>' + h + '</th>').join('') + '</tr>' +
                    rows.map(r => '<tr>' + r.map(c => '<td>' + c + '</td>').join('') + '</tr>').join('') + '</table>';
                const blob = new Blob([xls], {type: 'application/vnd.ms-excel'});
                saveAs(blob, 'export-housekeeping.xls');
                showResult('Excel file downloaded successfully!', 'success');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<strong>${type === 'success' ? '✅' : '❌'} ${message}</strong>`;
            resultDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            resultDiv.style.color = type === 'success' ? '#155724' : '#721c24';
        }

        function testCopy() {
            exportFilteredData('copy');
        }

        function testCSV() {
            exportFilteredData('csv');
        }

        function testExcel() {
            exportFilteredData('excel');
        }
    </script>
</body>
</html> 